# Author: Philip Weigel

record(aai, "$(DEVICE):data") {
    field(DESC, "All interlocks")
    field(DTYP, "stream")
    field(INP, "@libcom1.proto read_all_array $(PORT)")
    field(SCAN, ".1 second")
    field(NELM, "4")
    field(FTVL, "DOUBLE")
    field(FLNK, "$(DEVICE):int:fanout.PROC PP")
    field(PINI, "YES")
}

record(fanout, "$(DEVICE):int:fanout") {
    field(SELM, "All")
    field(LNK0, "$(DEVICE):i1:get_interlock")
    field(LNK1, "$(DEVICE):i2:get_interlock")
    field(PINI, "YES")
}

record(bi, "$(DEVICE):i1:get_interlock") {
    field(DESC, "Get interlock 1 status")
    field(INP, "$(DEVICE):data.VAL[0] CA")
    field(ZNAM, "Closed")
    field(ONAM, "Open")
    field(OSV, "MAJOR")  # Severity of a one-value error
    field(SCAN, "Passive") 
    field(PINI, "YES")
    field(SIMM, "NO")
    field(SVAL, 0)
}

record(bi, "$(DEVICE):i2:get_interlock") {
    field(DESC, "Get interlock 2 status")
    field(INP, "$(DEVICE):data.VAL[1] CA")
    field(ZNAM, "Closed")
    field(ONAM, "Open")
    field(OSV, "MAJOR")  #Severity of a one-value error
    field(SCAN, "Passive")
    field(PINI, "YES")
    field(SIMM, "NO")
    field(SVAL, 0)
}

# Might want to look at DOL for some of the power supplies for 'continuous control'
# https://epics.anl.gov/base/R7-0/6-docs/boRecord.html
record(calc, "interlock_status") {
    field(DESC, "Status of the interlocks")
    field(INPA, "$(DEVICE):i1:get_interlock.VAL NPP")
    field(INPB, "$(DEVICE):i2:get_interlock.VAL NPP")
    field(CALC, "A||B ? 1 : 0")  # 1 if A or B, 0 otherwise
    field(SCAN, "Passive")
}
